# 私有 AI 对话网站 — 技术方案 v2.0（自托管版）

> 版本：v2.0 | 日期：2026-02-21
>
> 变更记录：v2.0 — 改为纯自托管方案（Docker Compose 部署 PostgreSQL + Next.js），无需依赖外部云服务

---

## 1. 项目概述

### 1.1 项目目标

搭建一个**小规模、受控访问**的 AI 对话网站，部署在云服务器上，对接已有的 Anthropic 格式 API，为白名单用户提供安全、可审计的 AI 对话服务。

### 1.2 规模定位

- **用户量**：数十人级别，白名单控制
- **部署方式**：云服务器（阿里云/腾讯云/AWS等）
- **运维目标**：单机 Docker Compose 一键部署，无需外部云服务依赖

### 1.3 核心需求

| 需求 | 描述 |
|------|------|
| **AI 对话** | 多轮对话、流式输出(SSE)、会话管理、Markdown 渲染 |
| **白名单注册** | 仅白名单邮箱可注册，管理员预先添加 |
| **管理后台** | 用户管理、白名单管理、用量统计、聊天记录审计 |

---

## 2. 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **框架** | Next.js 15 (App Router) | 全栈方案，前后端统一 |
| **语言** | TypeScript 5 | 全栈类型安全 |
| **数据库** | PostgreSQL 16 (Docker) | 自托管，数据完全自主 |
| **ORM** | Prisma 5 | 类型安全的数据库访问 |
| **认证** | iron-session | 轻量级服务端 Session，无外部依赖 |
| **密码加密** | bcryptjs | 安全可靠 |
| **UI 框架** | Tailwind CSS + shadcn/ui | 快速构建现代化 UI |
| **状态管理** | Zustand | 轻量级前端状态 |
| **Markdown 渲染** | react-markdown + remark-gfm + rehype-highlight | AI 输出渲染 |
| **部署** | Docker Compose | 单机一键部署所有组件 |
| **包管理** | pnpm | 快速、节省空间 |

---

## 3. 系统架构

### 3.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                      客户端（浏览器）                     │
└─────────────────────────┬───────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                  云服务器（Docker Compose）               │
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌───────────┐   │
│  │   Nginx     │───▶│  Next.js    │───▶│ PostgreSQL│   │
│  │  (80/443)   │    │   (3000)    │    │  (5432)   │   │
│  └─────────────┘    └─────────────┘    └───────────┘   │
│                           │                             │
│                           ▼                             │
│                    ┌─────────────┐                       │
│                    │  AI API     │                       │
│                    │ (外部服务)   │                       │
│                    └─────────────┘                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 组件说明

| 组件 | 容器/服务 | 职责 |
|------|-----------|------|
| Nginx | nginx:alpine | 反向代理、HTTPS、静态资源 |
| Next.js | node:20-alpine | 前端渲染、API路由、业务逻辑 |
| PostgreSQL | postgres:16-alpine | 数据持久化 |

---

## 4. 数据库设计

### 4.1 Prisma Schema

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ 用户表（含认证信息）============
model User {
  id             String     @id @default(cuid())
  email          String     @unique
  passwordHash   String     @map("password_hash")
  name           String?
  role           Role       @default(USER)
  status         UserStatus @default(ACTIVE)
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  lastLoginAt    DateTime?  @map("last_login_at")

  conversations Conversation[]
  usageLogs     ApiUsageLog[]
  auditLogs     AdminAuditLog[] @relation("AdminAuditLogs")

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  DISABLED
}

// ============ 白名单表 ============
model Whitelist {
  id        String   @id @default(cuid())
  email     String   @unique
  note      String?
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")

  @@map("whitelist")
}

// ============ 会话表 ============
model Conversation {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  title     String   @default("新对话")
  model     String   @default("claude-sonnet-4-20250514")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId, updatedAt(sort: Desc)])
  @@map("conversations")
}

// ============ 消息表 ============
model Message {
  id             String      @id @default(cuid())
  conversationId String      @map("conversation_id")
  role           MessageRole
  content        String
  createdAt      DateTime    @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

enum MessageRole {
  user
  assistant
}

// ============ API 用量日志表 ============
model ApiUsageLog {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  conversationId String?  @map("conversation_id")
  model          String
  inputTokens    Int      @map("input_tokens")
  outputTokens   Int      @map("output_tokens")
  totalTokens    Int      @map("total_tokens")
  durationMs     Int?     @map("duration_ms")
  createdAt      DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("api_usage_logs")
}

// ============ 管理员审计日志表 ============
model AdminAuditLog {
  id        String   @id @default(cuid())
  adminId   String   @map("admin_id")
  action    String
  target    String?
  detail    Json?
  createdAt DateTime @default(now()) @map("created_at")

  admin User @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, createdAt])
  @@index([createdAt])
  @@map("admin_audit_logs")
}
```

---

## 5. 环境变量

```bash
# ============ 数据库 ============
DATABASE_URL="postgresql://ai_chat_user:your_secure_password@db:5432/ai_chat_db"

# ============ Session / Cookie ============
SESSION_SECRET="your-random-32-char-secret-key-here"

# ============ AI API ============
AI_API_BASE_URL="https://your-api-host.com"
AI_API_KEY="your-api-key"

# ============ 应用配置 ============
DEFAULT_MODEL="claude-sonnet-4-20250514"
MAX_TOKENS_PER_REQUEST=4096
DAILY_TOKEN_LIMIT=100000
MAX_MESSAGE_LENGTH=10000

# ============ 初始管理员 ============
ADMIN_EMAIL="admin@example.com"
ADMIN_PASSWORD="change-me-on-first-login"
```

---

## 6. Docker Compose 部署

### 6.1 docker-compose.yml

```yaml
version: "3.8"

services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-ai_chat_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-change_me_in_production}
      POSTGRES_DB: ${DB_NAME:-ai_chat_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ai_chat_user} -d ${DB_NAME:-ai_chat_db}"]
      interval: 5s
      timeout: 5s
      retries: 5

  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${DB_USER:-ai_chat_user}:${DB_PASSWORD:-change_me_in_production}@db:5432/${DB_NAME:-ai_chat_db}
      SESSION_SECRET: ${SESSION_SECRET}
      AI_API_BASE_URL: ${AI_API_BASE_URL}
      AI_API_KEY: ${AI_API_KEY}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-claude-sonnet-4-20250514}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "127.0.0.1:3000:3000"

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - app

volumes:
  postgres_data:
```

### 6.2 Dockerfile

```dockerfile
FROM node:20-alpine AS base

RUN corepack enable && corepack prepare pnpm@latest --activate

# 依赖安装
FROM base AS deps
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# 构建
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

RUN pnpm prisma generate
RUN pnpm build

# 生产运行
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/node_modules/.pnpm/@prisma+client* ./node_modules/.pnpm/
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

USER nextjs

EXPOSE 3000
ENV PORT=3000

# 启动时执行数据库迁移并启动应用
CMD ["sh", "-c", "npx prisma migrate deploy && node server.js"]
```

---

## 7. 认证方案（iron-session）

### 7.1 为什么选择 iron-session？

| 特性 | iron-session | NextAuth.js |
|------|-------------|-------------|
| 外部依赖 | 无 | 需要 OAuth 提供商（可选） |
| 复杂度 | 轻量级，~200行代码 | 功能丰富但较重 |
| Session 存储 | 加密 Cookie（无服务端存储） | 数据库/ JWT |
| 适合场景 | 自建用户系统 | 第三方登录为主 |

本项目使用 **iron-session** 实现轻量级 Session 认证，密码使用 bcryptjs 加密存储在 PostgreSQL 中。

### 7.2 Session 配置

```typescript
// lib/session.ts
import { getIronSession, IronSessionOptions } from "iron-session";
import { cookies } from "next/headers";

export interface SessionData {
  userId: string;
  email: string;
  role: "USER" | "ADMIN";
  isLoggedIn: boolean;
}

export const sessionOptions: IronSessionOptions = {
  password: process.env.SESSION_SECRET!,
  cookieName: "ai-chat-session",
  cookieOptions: {
    secure: process.env.NODE_ENV === "production",
    maxAge: 60 * 60 * 24 * 7, // 7 天
  },
};

export async function getSession() {
  const cookieStore = await cookies();
  return getIronSession<SessionData>(cookieStore, sessionOptions);
}
```

---

## 8. 部署步骤

### 8.1 准备服务器

```bash
# 1. 购买云服务器（1核2G，Ubuntu 22.04）
# 2. 安装 Docker 和 Docker Compose
curl -fsSL https://get.docker.com | sh
```

### 8.2 部署应用

```bash
# 1. 克隆代码
git clone https://github.com/your-repo/ai-chat-site.git
cd ai-chat-site

# 2. 创建环境变量文件
cp .env.example .env
# 编辑 .env 文件，填写你的配置

# 3. 启动服务
docker-compose up -d

# 4. 查看日志
docker-compose logs -f app
```

### 8.3 初始化管理员

首次启动时会自动创建管理员账号（使用 .env 中配置的 ADMIN_EMAIL 和 ADMIN_PASSWORD）。

---

## 9. 优势对比

### v2.0（自托管）vs v1.1（Supabase）

| 对比项 | v2.0 自托管 | v1.1 Supabase |
|--------|-------------|---------------|
| **数据控制权** | 完全自主 | 托管在第三方 |
| **外部依赖** | 仅 AI API | Supabase + AI API |
| **长期成本** | 固定（服务器费用） | 可能增长（按用量） |
| **隐私合规** | 更易满足 | 需评估 |
| **部署复杂度** | 单机一键部署 | 需配置外部服务 |
| **运维工作** | 需自行备份数据库 | Supabase 自动备份 |
| **扩展性** | 垂直扩展 | 托管服务自动扩展 |

---

## 10. 备份策略

```bash
# 数据库备份脚本（建议每日执行）
docker-compose exec -T db pg_dump -U ai_chat_user ai_chat_db > backup_$(date +%Y%m%d).sql

# 恢复
docker-compose exec -T db psql -U ai_chat_user ai_chat_db < backup_20250221.sql
```

---

## 11. 费用估算

| 资源 | 规格 | 月费用 |
|------|------|--------|
| 云服务器 | 1核2G | ¥60-100 |
| 域名 | .com | ¥5-7 |
| **合计** | | **¥65-107/月** |

无需额外数据库费用（自托管），无 Supabase 订阅费用。
