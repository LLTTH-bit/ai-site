generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============ 用户表 ============
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String?
  role         String    @default("USER")
  status       String    @default("ACTIVE")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  conversations Conversation[]
  usageLogs     ApiUsageLog[]
  auditLogs     AdminAuditLog[]

  @@map("users")
}

// ============ 白名单表 ============
model Whitelist {
  id        String   @id @default(cuid())
  email     String   @unique
  note      String?
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  createdBy String

  @@map("whitelist")
}

// ============ 会话表 ============
model Conversation {
  id        String   @id @default(cuid())
  userId    String
  title     String   @default("新对话")
  model     String   @default("Qwen/Qwen2.5-7B-Instruct")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId, updatedAt(sort: Desc)])
  @@map("conversations")
}

// ============ 消息表 ============
model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String
  content        String
  paused         Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

// ============ API 用量日志表 ============
model ApiUsageLog {
  id             String   @id @default(cuid())
  userId         String
  conversationId String?
  model          String
  inputTokens    Int
  outputTokens   Int
  totalTokens    Int
  durationMs     Int?
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([createdAt])
  @@map("api_usage_logs")
}

// ============ 管理员审计日志表 ============
model AdminAuditLog {
  id        String   @id @default(cuid())
  adminId   String
  action    String
  target    String?
  detail    String?
  createdAt DateTime @default(now())

  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId, createdAt])
  @@index([createdAt])
  @@map("admin_audit_logs")
}
