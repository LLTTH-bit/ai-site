# 方案对比与迁移说明

## 版本对比

| 特性 | v2.0 自托管方案 | v1.1 Supabase 方案 |
|------|-----------------|-------------------|
| **数据控制权** | 完全自主 | 托管在第三方 |
| **外部依赖** | 仅 AI API | Supabase + AI API |
| **部署复杂度** | Docker Compose 一键部署 | 需配置 Supabase 项目 |
| **运维工作** | 自行备份数据库 | Supabase 自动备份 |
| **长期成本** | 固定（服务器费用） | 可能增长（按用量） |
| **隐私合规** | 更易满足 | 需评估 |
| **技术栈** | iron-session + bcryptjs | Supabase Auth |
| **数据库** | Docker PostgreSQL | Supabase PostgreSQL |

## 核心变更

### 1. 认证方式变更

**v1.1 (Supabase)**
```typescript
// 使用 Supabase Auth
const supabase = await createClient();
const { data: { user } } = await supabase.auth.getUser();
```

**v2.0 (自托管)**
```typescript
// 使用 iron-session + bcryptjs
const session = await getSession();
// 密码存储在 users 表的 password_hash 字段
```

### 2. 环境变量变更

**移除的环境变量:**
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `DIRECT_URL`

**新增的环境变量:**
- `SESSION_SECRET` - Session 加密密钥
- `ADMIN_EMAIL` - 初始管理员邮箱
- `ADMIN_PASSWORD` - 初始管理员密码

### 3. 数据库 Schema 变更

**主要变更:**
- `Profile` 表重命名为 `User`
- `User` 表新增 `password_hash` 字段
- 移除与 Supabase Auth 的关联依赖

## 部署步骤对比

### v2.0 自托管部署（更简单）

```bash
# 1. 服务器安装 Docker
curl -fsSL https://get.docker.com | sh

# 2. 克隆项目
git clone <repo>
cd ai-chat-site

# 3. 配置环境变量
cp .env.example .env
# 编辑 .env 填入配置

# 4. 一键启动
docker-compose up -d

# 5. 完成！访问 http://your-domain.com
```

### v1.1 Supabase 部署（需外部配置）

```bash
# 1. 注册 Supabase 账号
# 2. 创建项目并获取配置
# 3. 配置数据库触发器
# 4. 部署 Next.js 应用
# 5. 配置环境变量指向 Supabase
```

## 为什么选择 v2.0？

1. **数据自主**: 所有数据存储在自己的服务器上
2. **简单部署**: 单机 Docker Compose，无外部依赖
3. **成本可控**: 无按量计费，固定成本
4. **隐私合规**: 更易满足数据本地化要求
5. **离线可用**: 不依赖外部云服务连接

## 文件清单

已更新的文件:
- `package.json` - 更新依赖
- `prisma/schema.prisma` - 新数据库模型
- `lib/session.ts` - Session 管理（新增）
- `lib/password.ts` - 密码工具（新增）
- `lib/prisma.ts` - 保留
- `lib/validators.ts` - 保留
- `middleware.ts` - 适配新认证
- `app/api/auth/*` - 新认证 API
- `app/api/chat/route.ts` - 适配新认证
- `app/api/conversations/route.ts` - 适配新认证
- `.env.example` - 新环境变量模板
- `docker-compose.yml` - 包含 PostgreSQL
- `Dockerfile` - 构建配置
- `nginx.conf` - Nginx 配置
- `prisma/seed.ts` - 管理员初始化

已删除的文件:
- `lib/supabase/server.ts`
- `lib/supabase/client.ts`
- `app/api/auth/callback/*`

## 下一步

1. 配置 `.env` 文件
2. 运行 `docker-compose up -d`
3. 访问应用并使用管理员账号登录
4. 在管理后台添加白名单用户
