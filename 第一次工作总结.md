# 第一次工作总结

> 日期：2026-02-22

## 一、项目概述

本次工作主要完成了一个**私有 AI 对话网站**的技术方案设计，该项目旨在搭建一个**小规模、受控访问**的 AI 对话网站，部署在云服务器上，对接已有的 Anthropic 格式 API（`/v1/messages`），为白名单用户提供安全、可审计的 AI 对话服务。

### 项目规模定位
- **用户量**：数十人级别，白名单控制
- **部署方式**：云服务器（如阿里云 / 腾讯云 / AWS 等）
- **运维目标**：尽量少的自托管组件，降低运维负担

### 三大核心需求

| 需求 | 描述 |
|------|------|
| **AI 对话功能** | 支持多轮对话、流式输出（SSE）、会话管理（新建/历史/删除）、Markdown 渲染 |
| **白名单注册机制** | 仅白名单中的邮箱可注册；管理员预先添加白名单条目；注册后自动关联 |
| **管理后台** | 用户管理、白名单管理、用量统计（token 消耗）、聊天记录审计、系统仪表盘 |

---

## 二、技术选型

| 层级 | 技术选型 | 说明 |
|------|---------|------|
| **框架** | Next.js 15 (App Router) | 全栈方案，前后端统一，支持 Server Actions、Route Handlers、Middleware |
| **语言** | TypeScript 5 | 全栈类型安全 |
| **后端服务** | Supabase（云版） | 提供托管 PostgreSQL + 认证服务 + 实时订阅，免数据库运维 |
| **ORM** | Prisma 6 | 连接 Supabase 的 PostgreSQL，提供类型安全的数据库访问和迁移管理 |
| **认证** | Supabase Auth | 内置邮箱密码注册/登录，支持 OAuth，与 Supabase 数据库深度集成 |
| **UI 框架** | Tailwind CSS 4 + shadcn/ui | 快速构建现代化 UI，组件可定制性强 |
| **状态管理** | Zustand | 轻量级，适合管理对话列表、当前会话等前端状态 |
| **Markdown 渲染** | react-markdown + remark-gfm + rehype-highlight | AI 输出渲染，支持代码高亮 |
| **部署** | Docker + Nginx（仅应用层） | 容器化部署 Next.js 应用，数据库由 Supabase 云托管 |
| **包管理** | pnpm | 快速、节省磁盘空间 |

---

## 三、已完成的工作

### 1. 技术方案文档

完成了详细的技术方案设计文档（`技术方案.md`），包括：

- **系统架构设计**：绘制了完整的系统架构图，明确了客户端、云服务器、Supabase Cloud 和 AI API 之间的交互关系
- **数据库设计**：设计了完整的 Prisma Schema，包括：
  - `profiles`（用户资料表）
  - `whitelist`（白名单表）
  - `conversations`（会话表）
  - `messages`（消息表）
  - `api_usage_logs`（API 用量日志表）
  - `admin_audit_logs`（管理员审计日志表）
- **API 端点设计**：规划了所有认证、对话和管理后台的 API 路由
- **认证与白名单机制**：设计了完整的注册流程、白名单校验逻辑和 JWT 角色同步方案
- **AI 对话流式代理**：详细实现了 `/api/chat` 的 SSE 代理逻辑，包括 Anthropic 事件类型解析和 token 用量统计
- **管理后台功能**：规划了仪表盘、用户管理、白名单管理、用量统计、聊天记录查看、审计日志等模块
- **安全考量**：涵盖了身份认证安全、API 安全、API 密钥保护、数据安全和配额防护等方面
- **部署方案**：设计了基于 Docker + Nginx 的部署架构，配置了 SSE 专用的 Nginx 参数
- **开发阶段规划**：将项目分为 6 个阶段，从初始化到部署上线

### 2. 项目初始化

使用 Create Next App 初始化了 Next.js 15 项目：

- 使用 TypeScript
- 使用 ESLint
- 使用 Tailwind CSS
- 使用 App Router（默认）
- 使用 `src/` 目录（默认）

当前项目结构：
```
ai-site/
├── app/                    # Next.js App Router
├── public/                 # 静态资源
├── node_modules/           # 依赖
├── .gitignore
├── eslint.config.mjs
├── next.config.ts
├── package.json
├── postcss.config.mjs
├── tsconfig.json
└── 技术方案.md             # 技术方案文档
```

---

## 四、项目当前状态

| 项目 | 状态 |
|------|------|
| 技术方案 | ✅ 已完成 |
| 项目初始化 | ✅ 已完成 |
| 数据库配置 | ⏳ 待完成 |
| 认证系统实现 | ⏳ 待完成 |
| AI 对话功能实现 | ⏳ 待完成 |
| 管理后台实现 | ⏳ 待完成 |
| 部署上线 | ⏳ 待完成 |

---

## 五、后续开发计划

根据技术方案中的开发阶段规划，下一步工作应按以下顺序进行：

### 阶段 1：项目初始化（补充）
- [ ] 创建 Supabase 项目，获取 URL / anon key / service_role key / 数据库连接串
- [ ] 配置 Prisma 连接 Supabase PostgreSQL（`DATABASE_URL` + `DIRECT_URL`）
- [ ] 创建数据库 Schema 并运行 `prisma migrate dev`
- [ ] 在 Supabase SQL Editor 中执行触发器脚本
- [ ] 编写并运行 seed 脚本（创建初始管理员账号）

### 阶段 2：认证系统
- [ ] 安装 `@supabase/ssr` + `@supabase/supabase-js`
- [ ] 创建服务端/客户端 Supabase Client 工具函数
- [ ] 实现注册 API（白名单校验 → Supabase Auth signUp）
- [ ] 实现登录/注册页面 UI
- [ ] 配置 Middleware 路由保护

### 阶段 3：AI 对话核心
- [ ] 实现 `/api/chat` 流式代理
- [ ] 实现对话 CRUD API
- [ ] 开发对话页面 UI
- [ ] 开发会话侧边栏
- [ ] 实现 token 用量记录

### 阶段 4：管理后台
- [ ] 管理后台布局
- [ ] 仪表盘页面
- [ ] 用户管理页面
- [ ] 白名单管理页面
- [ ] 用量统计页面
- [ ] 聊天记录查看页面
- [ ] 审计日志页面

### 阶段 5：安全加固与优化
- [ ] 请求限流
- [ ] 输入校验
- [ ] 每日 Token 配额限制
- [ ] 并发请求限制

### 阶段 6：部署上线
- [ ] 编写 Dockerfile 与 docker-compose.yml
- [ ] 配置 Nginx（含 SSE 代理）
- [ ] 配置 HTTPS
- [ ] 上线验证与联调测试

---

## 六、技术决策要点

1. **为什么选 Next.js 全栈？**
   - 前后端统一，一套代码库、一套部署流程
   - Route Handlers 原生支持 ReadableStream，天然适合流式代理
   - Middleware 路由级鉴权保护

2. **为什么选 Supabase（而非自建 PostgreSQL + Auth.js）？**
   - 运维简化，数据库托管
   - 认证开箱即用
   - 小规模友好（免费套餐足够数十人使用）
   - 服务器无需运行数据库

3. **为什么保留 Prisma（而非纯用 supabase-js 查询）？**
   - 类型安全，Prisma Client 自动生成 TypeScript 类型
   - 迁移管理，`prisma migrate` 版本化管理 Schema 变更
   - 如未来从 Supabase 迁走，Prisma 层不用改动

---

## 七、关键风险与应对

| 风险 | 应对措施 |
|------|---------|
| AI API 不可用或响应慢 | 实现请求超时（300s）；前端显示友好错误提示 |
| SSE 流中断 | 前端检测连接中断并提示重试；后端保存已收到的部分内容 |
| Token 消耗失控 | 实施每用户每日 Token 上限；仪表盘实时监控用量 |
| 密钥泄露 | 环境变量管理密钥；service_role key 不暴露前端 |
| Supabase 服务中断 | 定期导出数据库备份；架构设计上可快速切换到自建 PG |
| Nginx 缓冲 SSE | `proxy_buffering off` + `gzip off` |

---

## 八、总结

本次工作完成了私有 AI 对话网站项目的完整技术方案设计，详细规划了系统架构、数据库设计、API 端点、认证机制、AI 对话流式代理、管理后台功能、安全策略和部署方案。项目已通过 Create Next App 初始化了基础结构，后续可按照开发阶段规划逐步实现各模块功能。

技术方案文档位置：`E:\claude\ai-site\技术方案.md`
